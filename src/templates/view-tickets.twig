{# @var craft \craft\web\twig\variables\CraftVariable #}
{#
/**
 * Helpdesk Support plugin for Craft CMS 3.x
 *
 * Helpdesk Support index.twig
 *
 * @author    Jarrod D Nix
 * @copyright Copyright (c) 2019 Jarrod D Nix
 * @link      https://jarrodnix.me
 * @package   HelpdeskSupport
 * @since     0.1.0
 */
#}

{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% do view.registerAssetBundle("jrrdnx\\helpdesksupport\\assetbundles\\helpdesksupport\\HelpdeskSupportAsset") %}
{% do view.registerAssetBundle("jrrdnx\\helpdesksupport\\assetbundles\\viewticketscpsection\\ViewTicketsCPSectionAsset") %}

{# Link for the ? icon at the bottom of the page #}
{% set docsUrl = "https://github.com/jrrdnx/helpdesk-support/blob/master/README.md" %}

{# The title of this CP section #}
{% set title = "View Tickets" %}

{# The URL to this plugin's base CP section #}
{% set pluginCpUrl = url('helpdesk-support') %}

{# Get a URL to an image in our AssetBundle #}
{% set iconUrl = view.getAssetManager().getPublishedUrl('@jrrdnx/helpdesksupport/assetbundles/viewticketscpsection/dist', true) ~ '/img/ViewTickets-icon.svg' %}

{% set subnav = {
    "create-new-ticket": { label: "Create New Ticket"|t('helpdesk-support'), url: url(pluginCpUrl ~ '/create-new-ticket') },
    "view-tickets": { label: "View Tickets"|t('helpdesk-support'), url: url(pluginCpUrl ~ '/view-tickets') },
} %}
{% set selectedSubnavItem = 'view-tickets' %}

{% set crumbs = [
    { label: "Helpdesk Support", url: url(pluginCpUrl) },
] %}

{# Content that should appear in the page header#}
{% set extraPageHeaderHtml %}
    <div class="buttons">
        <a href="{{ pluginCpUrl }}" class="btn submit add icon">{{ "Click Me!"|t('helpdesk-support') }}</a>
    </div>
{% endset %}

{% macro activeTicketRow(ticket, pluginCpUrl) %}
	<tr>
		<td>
			<a href="{{ url(pluginCpUrl ~ '/view-ticket/' ~ ticket.id) }}">
				{% if ticket.hsSubject|length > 50 %}
					{{ ticket.hsSubject|slice(0, 50)|trim }}...
				{% else %}
					{{ ticket.hsSubject }}
				{% endif %}
			</a>
		</td>
		<td>{{ ticket.id }}</td>
		<td>{{ ticket.hsCreatedAt|date('M d') }}</td>
		<td>{{ ticket.hsUpdatedAt|date('M d') }}</td>
		<td class="ticket-status-cell">
			<span class="helpdesk-support-ticket-status {{ ticket.status }}">{{ ticket.status }}</span>
		</td>
	</tr>
{% endmacro %}

{# The content of the CP Section#}
{% set content %}

	{% if userFound == false %}

		<p class="no-user-found">Please contact your Project Manager/Developer to set up a helpdesk account.</p>

	{% else %}

		<table class="ticket-list">
			<thead>
				<tr>
					<th>Subject</th>
					<th>ID</th>
					<th>Created</th>
					<th>Last Activity</th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				{% if tickets|length > 0 %}
					{% for ticket in tickets %}
						{{ _self.activeTicketRow(ticket, pluginCpUrl) }}
					{% endfor %}
				{% else %}
					<tr>
						<td colspan="5">
							<p class="no-tickets-found">No tickets found.&nbsp;<a href="{{ url(pluginCpUrl ~ '/create-new-ticket') }}">Create a new ticket</a></p>
						</td>
					</tr>
				{% endif %}
			</tbody>
		</table>

	{% endif %}

{% endset %}
